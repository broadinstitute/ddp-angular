version: 2.1

references:
  repo_path: &repo_path
      /home/circleci/repo
  ng_workspace_path: &ng_workspace_path
      /home/circleci/repo/ddp-workspace
  playwright_path: &playwright_path
      /home/circleci/repo/playwright-e2e
  npm_cache_key: &npm_cache_key
    v1-dependency-npm2-{{ checksum "package.json" }}-{{ checksum "package-lock.json" }}
  npm_cache_restore_key: &npm_cache_restore_key
    keys:
      - *npm_cache_key
  # Note: important that values of guids and keys have matching order!"
  study_keys: &study_keys
    "basil dsm-ui osteo brain angio mbc testboston mpc prion atcp rarex rgp esc cgc circadia pancan singular brugada lms fon"
  study_guids: &study_guids
    "basil NA CMI-OSTEO cmi-brain ANGIO cmi-mbc testboston cmi-mpc PRION atcp rarex RGP cmi-esc cgc circadia cmi-pancan singular brugada cmi-lms fon"

  # Job runs for PR branch only
  filter-pr-branch: &filter-pr-branch
    filters:
      tags:
        ignore: /.*/
      branches:
        ignore: develop

  filter-develop-branch: &filter-develop-branch
    filters:
      branches:
        only: develop

# Container for all the builds
executors:
  build-executor:
    docker:
      - image: broadinstitute/study-website-build:12-08-2020A
    working_directory: *ng_workspace_path
    resource_class: medium+
  playwright-test-executor:
    resource_class: medium+
    docker:
      - image: broadinstitute/study-website-build:12-08-2020A
      - image: mcr.microsoft.com/playwright:v1.25.0-focal
    working_directory: *ng_workspace_path
    environment:
      NODE_ENV: development # Needed if playwright is in devDependencies

commands:
  app-build-and-store:
    description: Run build and store archive of it
    parameters:
      study_key:
        type: string
    steps:
      - setup-build-workspace
      - set-deployment-environment
      - setup-shared-env:
          study_key: << parameters.study_key >>
      - run-linter-check
      - run-tests
      - build-app:
          study_key: << parameters.study_key >>
      - store-app-build

  app-build-and-deploy:
    description: Run build and immediately deploy it to GAE
    parameters:
      study_key:
        type: string
      skip_build:
        type: boolean
        default: false
    steps:
      - setup-build-workspace
      - setup-shared-env:
          study_key: << parameters.study_key >>
      - unless:
          condition: << parameters.skip_build >>
          steps:
            - set-deployment-environment
            - run-linter-check
            - run-tests
            - build-app:
                study_key: << parameters.study_key >>
            - deploy-exploded-build:
                study_key: << parameters.study_key >>

  set-deployment-environment:
    description: "Determine working environment"
    steps:
      - run:
          name: Determine environment for branch << pipeline.git.branch >>
          command: |
            if [ "<< pipeline.parameters.deploy_env >>" != "UNKNOWN" ]
            then
              DEPLOY_TARGET_ENV="<< pipeline.parameters.deploy_env >>"
            else
              DEPLOY_TARGET_ENV="<< pipeline.git.branch >>"
            fi

            case $DEPLOY_TARGET_ENV in
              dev*)
                DEPLOY_ENV=dev
                BUILD_PARAMS=--sourceMap
              ;;
              test)
                DEPLOY_ENV=test
                BUILD_PARAMS=--sourceMap
              ;;
              staging)
                DEPLOY_ENV=staging
              ;;
              prod*)
                DEPLOY_ENV=prod
              ;;
              *)
                DEPLOY_ENV=dev
                BUILD_PARAMS=--sourceMap
                echo "Defaulting $DEPLOY_TARGET_ENV to dev environment"
              ;;
            esac
            echo "Setting deployment ENVIRONMENT to $DEPLOY_ENV"
            echo "export ENVIRONMENT=$DEPLOY_ENV" >> $BASH_ENV
            echo "export BUILD_PARAMS=$BUILD_PARAMS" >> $BASH_ENV
            source $BASH_ENV

  deploy-stored-build:
    description: Deploy archived build to GAE
    parameters:
      study_key:
        type: string
    steps:
      - checkout:
          path: *repo_path
      - setup-shared-env:
          study_key: << parameters.study_key >>
      - set-deployment-environment
      - run:
          name: Retrieve and expand build archive for << parameters.study_key >> with git SHA << pipeline.git.revision >>
          command: |
            set -u
            # we are getting our builds from the one bucket
            readvault.sh secret/pepper/prod/v1/conf .data.gcp.serviceKey | gcloud auth activate-service-account --key-file=-
            TAR_FILE_URL_PATTERN="gs://${BUILDS_BUCKET}/${ANGULAR_PROJECT_NAME}/${ANGULAR_PROJECT_NAME}_*_${SHORT_GIT_SHA}.tar.gz"
            echo "Looking for archive matching ${TAR_FILE_URL_PATTERN}"
            TAR_FILE_URL=`gsutil ls $TAR_FILE_URL_PATTERN  | sort -r | head -1`

            if [ -z $TAR_FILE_URL ]
            then
              echo "Could not find archive using pattern ${TAR_FILE_URL_PATTERN}"
              exit 1
            fi
            TAR_FILE_PATH="/tmp/$(basename -- $TAR_FILE_URL)"
            echo "Downloading ${TAR_FILE_URL} to ${TAR_FILE_PATH}"
            gsutil cp  $TAR_FILE_URL $TAR_FILE_PATH
            mkdir -p $OUTPUT_DIR && tar -xvf $TAR_FILE_PATH -C $OUTPUT_DIR
            echo "Contents of extracted archive at $OUTPUT_DIR"
            ls -l $OUTPUT_DIR
      - deploy-exploded-build:
          study_key: << parameters.study_key >>

  deploy-exploded-build:
    description: Deploy files to GAE
    parameters:
      study_key:
        type: string
    steps:
      - run:
          name: Setup gcloud context
          command: |
            set -u
            readvault.sh secret/pepper/${ENVIRONMENT}/v1/conf .data.gcp.serviceKey | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: <<parameters.study_key>> generate config files and copy pepperConfig.js
          command: |
            set -u
            if [[ "<<parameters.study_key>>" != "dsm-ui" ]]; then
              ./build-study.sh v1 $ENVIRONMENT . <<parameters.study_key>> "$STUDY_GUID" --config
              cd ddp-workspace
              CONFIG_DIR="${OUTPUT_DIR}/assets/config"
              mkdir -p $CONFIG_DIR
              CONFIG_FILE_SRC_PATH="${ANGULAR_PROJECT_DIR_PATH}/output-config/pepperConfig.js"
              cp  $CONFIG_FILE_SRC_PATH $CONFIG_DIR
              echo "$CONFIG_FILE_SRC_PATH has been copied to $CONFIG_DIR"

              if [[ "<<parameters.study_key>>" == "atcp" ]]; then
                cp "${ANGULAR_PROJECT_DIR_PATH}/output-config/app.yaml" "${ANGULAR_PROJECT_DIR_PATH}/app.yaml"
              fi
            else
              cd ddp-workspace
              CONFIG_DIR="${OUTPUT_DIR}/assets/js"
              mkdir -p $CONFIG_DIR
              gcloud --project="broad-ddp-${ENVIRONMENT}" secrets versions access latest --secret="study-manager-ui-config" > "${CONFIG_DIR}/ddp_config.js"
            fi
          environment: #Setting this ENV variable prevents launching a new Docker within build-study-sh script
            USE_DOCKER: false
          working_directory: *repo_path
      - run:
          name: Deploy to GAE
          command: |
            set -u
            gcloud app deploy --version="${SHORT_GIT_SHA}" --stop-previous-version --project "broad-ddp-${ENVIRONMENT}" "${ANGULAR_PROJECT_DIR_PATH}/app.yaml"
      - run:
          name: Update deployments sheet
          command: |
            set -u
            set +x
            readvault.sh secret/pepper/${ENVIRONMENT}/v1/conf .data.gcp.serviceKey | \
            reportdeploy.sh "$RELEASE_SHEET_ID" '<<parameters.study_key>> Angular client' "$ENVIRONMENT" "$CIRCLE_BUILD_NUM" "$CIRCLE_BUILD_URL"
      - run:
          name: Delete previous versions of service
          command: |
            set +x
            # extract the service name from the GAE yaml file
            CONFIG_FILE="${ANGULAR_PROJECT_DIR_PATH}/app.yaml"
            SERVICE=$(grep -Eo -m1 "^service:\s*.*" "${CONFIG_FILE}" | awk '{print $2}')
            echo "The service name is *${SERVICE}*"

            # find what other versions are currently running
            # skip first line, exclude our version, print 2nd column
            AWK_COMMMAND="NR > 1 && !/${SHORT_GIT_SHA}/ {print \$2}"
            VERSIONS_TO_DELETE=$(gcloud app versions list --service "$SERVICE" --project "broad-ddp-${ENVIRONMENT}" | awk "${AWK_COMMMAND}")

            # Sometime deleting versions fails. If there are less than 3 versions then we are not going to worry about it
            # and set flag so this job step does not fail when exit error value is generated
            if [[ ! -z $VERSIONS_TO_DELETE ]] && [[ "${#VERSIONS_TO_DELETE[@]}" -lt 3 ]]; then
              set +e
            fi

            for VERSION_TO_DELETE in $VERSIONS_TO_DELETE; do
              echo "Deleting version $VERSION_TO_DELETE of service $SERVICE"
              gcloud app versions delete --quiet --service "$SERVICE" "$VERSION_TO_DELETE" --project "broad-ddp-${ENVIRONMENT}"
            done;
            exit 0;

  setup-shared-env:
    description: "Setup shared ENV vars used by multiple scripts"
    parameters:
      study_key:
        type: string
        default: UNKNOWN
      study_keys:
        type: string
        default: *study_keys
      study_guids:
        type: string
        default: *study_guids
      repo_path:
        type: string
        default: *repo_path
    steps:
      - run:
          name: Set environment variables to build <<parameters.study_key>>
          command: |
            echo "export VAULT_TOKEN=`vault write -field=token auth/approle/login role_id=$VAULT_ROLE_ID secret_id=$VAULT_ROLE_SECRET_ID`" >> $BASH_ENV
            echo 'export PATH=$PATH:<< parameters.repo_path >>/build-utils' >> $BASH_ENV
            if [[ '<<parameters.study_key>>' != 'UNKNOWN' ]]; then
              echo 'export STUDY_KEY=<<parameters.study_key>>' >> $BASH_ENV
              STUDY_KEYS=(<<parameters.study_keys>>)
              STUDY_GUIDS=(<<parameters.study_guids>>)
              for i in ${!STUDY_KEYS[@]}; do
                  currentKey=${STUDY_KEYS[$i]}
                  if [[ $currentKey == '<<parameters.study_key>>' ]]; then
                      STUDY_GUID="${STUDY_GUIDS[$i]}"
                      echo "export STUDY_GUID=${STUDY_GUID}" >> $BASH_ENV
                      break;
                  fi
              done;
              if [[ -z $STUDY_GUID ]]; then
                echo "Could not find study guid for <<parameters.study_key>>"
                exit 1
              fi
              echo 'export ANGULAR_PROJECT_NAME=ddp-<<parameters.study_key>>' >> $BASH_ENV
              echo 'export ANGULAR_PROJECT_DIR_PATH=projects/ddp-<<parameters.study_key>>' >> $BASH_ENV
              source $BASH_ENV
              OUTPUT_DIR="${ANGULAR_PROJECT_DIR_PATH}/dist"
              echo "export OUTPUT_DIR=$OUTPUT_DIR" >> $BASH_ENV
            fi
            echo "export SHORT_GIT_SHA=`echo '<< pipeline.git.revision >>' | cut -c 1-7`" >> $BASH_ENV
            echo 'export BUILDS_BUCKET=ddp-build-artifacts' >> $BASH_ENV
            source $BASH_ENV

  setup-build-workspace:
    description: "Setup workspace used by all projects"
    steps:
      - checkout:
          path: *repo_path
      - restore_cache: *npm_cache_restore_key
      - run:
          name: Install dependencies
          command: |
            if [[ ! -d node_modules ]]; then
              npm ci
            else
              echo "package.json and package-lock.json unchanged, using cache"
            fi
      - save_cache:
          key: *npm_cache_key
          paths:
            - ./node_modules

  run-linter-check:
    description: "Run linter check"
    steps:
      - run:
          name: Linter check
          command: |
            ng lint ddp-sdk
            ng lint toolkit
            ng lint $ANGULAR_PROJECT_NAME
  run-tests:
    description: "Run all tests"
    steps:
      - run:
          name: ng test
          command: |
            mkdir -p /tmp/junit
            ng test ddp-sdk --watch=false --browsers ChromeHeadlessNoSandbox --reporters junit
            ng test toolkit --watch=false --browsers ChromeHeadlessNoSandbox --reporters junit
            ng test $ANGULAR_PROJECT_NAME --watch=false --browsers ChromeHeadlessNoSandbox --reporters junit
          environment:
            JUNIT_REPORT_PATH: /tmp/junit/
            JUNIT_REPORT_NAME: test-results.xml
          when: always
      - store_test_results:
          path: /tmp/junit
      - store_artifacts:
          path: /tmp/junit

  build-atcp-assets:
    description: build atcp auth0 scripts & styles
    steps:
      - run:
          name: build atcp auth0 scripts
          command: |
            set -u
            ng build ddp-atcp-auth
            npm run convert-atcp-auth-build-to-UMD
      - run:
          name: build atcp auth0 styles
          command: |
            set -u
            ./node_modules/.bin/sass ./projects/ddp-atcp/src/auth0/auth0-styles/main.scss ./projects/ddp-atcp/src/auth0/compiled/auth0-styles/main.css --style compressed

  execute-study-specific-commands:
    description: run study specific commands if necessary
    parameters:
      study_key:
        type: string
        default: "UNKNOWN"
    steps:
      - when:
          condition:
            equal: [ atcp, << parameters.study_key >> ]
          steps:
            - build-atcp-assets

  build-app:
    description: "Build DDP study app"
    parameters:
      study_key:
        type: string
        default: "UNKNOWN"
    steps:
      - when:
          condition:
            or:
              - equal: [ atcp, << parameters.study_key >> ]
          steps:
            - execute-study-specific-commands:
                study_key: << parameters.study_key >>
      - run:
          name: ng build
          command: |
            set -u
            export NODE_OPTIONS="--max-old-space-size=4096"
            ng build $ANGULAR_PROJECT_NAME $BUILD_PARAMS --prod --aot --base-href=/ --output-path=$OUTPUT_DIR --verbose=true --progress=true

  store-app-build:
    description: "Copy build to cloud storage"
    steps:
      - run:
          name: Create build archive
          command: |
            set -u
            DATE=`date +%F`
            TAR_NAME="${ANGULAR_PROJECT_NAME}_${DATE}_${SHORT_GIT_SHA}.tar.gz"
            TAR_PATH="/tmp/${TAR_NAME}"
            # Save some ENV vars for in job downstream
            echo "export TAR_NAME=$TAR_NAME" >> $BASH_ENV
            echo "export TAR_PATH=$TAR_PATH" >> $BASH_ENV
            cd ${OUTPUT_DIR}
            tar -czvf ${TAR_PATH} .
            echo "Tar file created at ${TAR_PATH}"
            ls -l $TAR_PATH
      - run:
          name: Store build archive
          command: |
            set -u
            readvault.sh secret/pepper/prod/v1/conf .data.gcp.serviceKey | gcloud auth activate-service-account --key-file=-
            gsutil cp  ${TAR_PATH} "gs://${BUILDS_BUCKET}/${ANGULAR_PROJECT_NAME}/${TAR_NAME}"

  conditionally-launch-build-and-deploy:
    description: Launch build and deploy if project has changed
    parameters:
      study_keys:
        type: string
    steps:
      - run:
          name: Check << parameters.study_keys >> and launch build if modified
          command: |
            set -u
            set +e
            set +x
            # CircleCi does not support arrays as params, so here is my workaround
            STUDY_KEYS=(<< parameters.study_keys >>)

            CHANGED_PROJECTS=$(findmodifiedprojects.sh <<pipeline.git.base_revision >> << pipeline.git.revision >>)

            echo "The following projects were found to have changed: $CHANGED_PROJECTS"

            for i in "${!STUDY_KEYS[@]}"; do
              STUDY_KEY=${STUDY_KEYS[$i]}

              NG_PROJECT_NAME="ddp-$STUDY_KEY"
              CHANGED_DEPENDENCIES=$(echo  $CHANGED_PROJECTS |
                  grep -E -e $NG_PROJECT_NAME -e _SHARED_  -e ddp-sdk -e toolkit)
              if [[ ! -z $CHANGED_DEPENDENCIES ]]; then
                echo "Launching build and deploy for $NG_PROJECT_NAME"
                curl -u "${CIRCLE_API_TOKEN}:" -X POST --header "Content-Type: application/json" -d "{
                                  \"branch\": \"<< pipeline.git.branch >>\",
                                  \"parameters\": {
                                      \"study_key\": \"$STUDY_KEY\",
                                      \"do-builds\": true
                                  }
                                }" https://circleci.com/api/v2/project/gh/broadinstitute/ddp-angular/pipeline
              else
                echo "Skipping $STUDY_KEY"
              fi
            done;

  conditionally-launch-build-and-store:
    description: Launch build and save job if build missing
    parameters:
      study_key:
        type: string
    steps:
      - setup-shared-env:
          study_key: << parameters.study_key >>
      - run:
          name: Initiate build for <<parameters.study_key>> and git SHA << pipeline.git.revision >> if existing one not found
          command: |
            set -u
            set +e
            readvault.sh secret/pepper/prod/v1/conf .data.gcp.serviceKey | gcloud auth activate-service-account --key-file=-
            TAR_FILE_URL_PATTERN="gs://${BUILDS_BUCKET}/${ANGULAR_PROJECT_NAME}/${ANGULAR_PROJECT_NAME}_*_${SHORT_GIT_SHA}.tar.gz"
            echo "Checking for ${TAR_FILE_URL_PATTERN}"
            # For some reason following line generating exit code 1 every time in CircleCI. Use set +e so script can continue
            TAR_FILE_URL=`gsutil ls $TAR_FILE_URL_PATTERN  | head -1`

            # if not found, let's kick off a build
            if [ -z $TAR_FILE_URL ]
              then
                echo "No build found for <<parameters.study_key>> with git sha ${SHORT_GIT_SHA}. Initiating a build for it."
                curl -u "${CIRCLE_API_TOKEN}:" -X POST --header "Content-Type: application/json" -d '{
                  "branch": "<< pipeline.git.branch >>",
                  "parameters": {
                      "study_key": "<<parameters.study_key>>",
                      "do-builds": true
                  }
                }' https://circleci.com/api/v2/project/gh/broadinstitute/ddp-angular/pipeline
              else
                echo "Build for <<parameters.study_key>> found at URL: ${TAR_FILE_URL}. No new build will be initiated"
            fi


jobs:
  build-and-deploy-job:
    working_directory: *ng_workspace_path
    parameters:
      study_key:
        type: string
    executor:
      name: build-executor
    steps:
      - app-build-and-deploy:
          study_key: << parameters.study_key >>
          skip_build: false

  conditionally-launch-build-and-deploy-all-job:
    working_directory: *ng_workspace_path
    executor:
      name: build-executor
    steps:
      - checkout:
          path: *repo_path
      - setup-shared-env
      - conditionally-launch-build-and-deploy:
          study_keys: *study_keys

  conditionally-launch-build-and-store-all-job:
    working_directory: *ng_workspace_path
    executor:
      name: build-executor
    steps:
      - checkout:
          path: *repo_path
      - conditionally-launch-build-and-store:
          study_key: basil
      - conditionally-launch-build-and-store:
          study_key: osteo
      - conditionally-launch-build-and-store:
          study_key: brain
      - conditionally-launch-build-and-store:
          study_key: angio
      - conditionally-launch-build-and-store:
          study_key: mbc
      - conditionally-launch-build-and-store:
          study_key: testboston
      - conditionally-launch-build-and-store:
          study_key: mpc
      - conditionally-launch-build-and-store:
          study_key: atcp
      - conditionally-launch-build-and-store:
          study_key: rarex
      - conditionally-launch-build-and-store:
          study_key: rgp
      - conditionally-launch-build-and-store:
          study_key: esc
      - conditionally-launch-build-and-store:
          study_key: prion
      - conditionally-launch-build-and-store:
          study_key: cgc
      - conditionally-launch-build-and-store:
          study_key: circadia
      - conditionally-launch-build-and-store:
          study_key: pancan
      - conditionally-launch-build-and-store:
          study_key: singular
      - conditionally-launch-build-and-store:
          study_key: brugada
      - conditionally-launch-build-and-store:
          study_key: lms
      - conditionally-launch-build-and-store:
          study_key: fon

  app-build-and-store-job:
    working_directory: *ng_workspace_path
    executor:
      name: build-executor
    steps:
      - app-build-and-store:
          study_key: << pipeline.parameters.study_key >>

  deploy-stored-build-job:
    working_directory: *ng_workspace_path
    parameters:
      study_key:
        type: string
    executor:
      name: build-executor
    steps:
      - deploy-stored-build:
          study_key: << parameters.study_key >>

  app-run-tests-job:
    working_directory: *ng_workspace_path
    executor:
      name: build-executor
    steps:
      - setup-build-workspace
      - setup-shared-env:
          study_key: << pipeline.parameters.study_key >>
      - run-linter-check
      - run-tests

  playwright-e2e-test:
    executor: playwright-test-executor
    parameters:
      study_key:
        type: string
        default: singular
      env_name:
        description: Must be one of "dev", "test", "staging"
        default: dev
        type: enum
        enum: [ dev, test, staging ]
      test_suite:
        description: Must be one of "nightly", "all".
        default: all
        type: enum
        enum: [ all, nightly ]
      optional_steps:
        type: steps
        default: [ ]
      parallel_num:
        type: integer
        default: 1
    parallelism: << parameters.parallel_num >>
    steps:
      - setup-build-workspace
      - setup-shared-env:
          study_key: << parameters.study_key >>
      - steps: << parameters.optional_steps >>
      - run:
          working_directory: *playwright_path
          name: "Override env_name"
          command: |
            if [[ ! "${ENVIRONMENT}" ]]; then
              echo "export ENV=<< parameters.env_name >>" >> $BASH_ENV
            else
              echo "export ENV=${ENVIRONMENT}" >> $BASH_ENV
            fi
            source $BASH_ENV
      - run:
          working_directory: *playwright_path
          name: "Export playwright-e2e .env"
          command: |
            cp "config/.env.${ENV}" .env
            cat .env | awk '{print "export " $0}' >> $BASH_ENV
            source $BASH_ENV
      - run:
          working_directory: *repo_path
          name: "Set environment variables for DSM from vault"
          command: |
            echo 'export sitePassword=$(vault read --format=json secret/pepper/test/v1/e2e | jq -r ".data.sitePassword")' >> $BASH_ENV
            echo 'export singularUserEmail=$(vault read --format=json secret/pepper/test/v1/e2e | jq -r ".data.users | .[0] | select(.app==\"google\") | .userName")' >> $BASH_ENV
            echo 'export dsmUserEmail=$(vault read --format=json secret/pepper/test/v1/e2e | jq -r ".data.users | .[] | select(.app==\"dsm\") | .userName")' >> $BASH_ENV
            echo 'export dsmUserPassword=$(vault read --format=json secret/pepper/test/v1/e2e | jq -r ".data.users | .[] | select(.app==\"dsm\") | .password")' >> $BASH_ENV
            source $BASH_ENV

            echo "debug:"
            echo $sitePassword
            echo $singularUserEmail
            echo $dsmUserEmail
            echo $dsmUserPassword
      - run:
          working_directory: *playwright_path
          name: Install NPM packages
          command: npm install --force --quiet
      - run:
          working_directory: *playwright_path
          command: npm run lint -- --max-warnings 0
      - run:
          working_directory: *playwright_path
          command: npm run build
      - run:
          working_directory: *playwright_path
          name: Install Playwright browsers dependencies
          command: |
            bash sudo npm cache clean -f
            bash sudo npm install -g n
            bash sudo n stable
            bash npx playwright install --with-deps chromium
      - when:
          condition:
            equal: [ all, << parameters.test_suite >> ]
          steps:
            - run:
                working_directory: *playwright_path
                name: Run all Playwright tests except nightly tests
                command: npx playwright test --config=playwright-ci.config.ts --grep-invert "/nightly/|/examples/"
      - when:
          condition:
            equal: [ nightly, << parameters.test_suite >> ]
          steps:
            - run:
                working_directory: *playwright_path
                name: Run all Playwright nightly tests
                command: npx playwright test --config=playwright-ci.config.ts --grep "nightly/"
      # File paths are relative and defined in playwright.config.ts Reporter section
      - store_test_results:
          path: ../playwright-e2e/test-results/junit
      - store_artifacts:
          path: ../playwright-e2e/test-results
      - store_artifacts:
          path: ../playwright-e2e/html-test-results

parameters:
  study_key:
    type: string
    default: "UNKNOWN"
  study_guid:
    type: string
    default: "UNKNOWN"
  api_call:
    type: enum
    enum: ["build-and-store","deploy", "run-tests", "run-e2e-test", "UNKNOWN"]
    default: "UNKNOWN"
  deploy_env:
    type: enum
    enum: ["dev", "test", "staging", "prod", "UNKNOWN"]
    default: "UNKNOWN"
  do-builds:
    type: boolean
    default: false

workflows:
  version: 2

  api-build-and-store-workflow:
    # Build study specified in api call
    when:
      and:
        - equal: ["build-and-store", << pipeline.parameters.api_call >>]
        - not:
            equal: ["UNKNOWN", << pipeline.parameters.study_key >>]
    jobs:
      - app-build-and-store-job

  api-deploy-workflow:
    # Deploy a study build to environment specified in api call
    when:
      and:
        - equal: ["deploy", << pipeline.parameters.api_call >>]
        - not:
            equal: ["UNKNOWN", << pipeline.parameters.deploy_env >>]
        - << pipeline.parameters.study_key >>
        - not:
            equal: ["UNKNOWN", << pipeline.parameters.study_key >>]
    jobs:
      - deploy-stored-build-job:
          study_key: << pipeline.parameters.study_key >>

  api-run-tests-workflow:
    # Run tests for study specified in api call (also tests for sdk and toolkit)
      when:
        and:
          - equal: ["run-tests", << pipeline.parameters.api_call >>]
          - not:
              equal: ["UNKNOWN", << pipeline.parameters.study_key >>]
      jobs:
        - app-run-tests-job

  playwright-e2e-test-workflow:
    # PR branch only:
    # Trigger manually by CircleCI API call via run_ci.sh
    # Run Playwright tests against Dev env to ensure tests are running without failure.
    when:
      and:
        - equal: ["run-e2e-test", << pipeline.parameters.api_call >>]
        - not:
            equal: [ "UNKNOWN", << pipeline.parameters.study_key >> ]
    jobs:
      - playwright-e2e-test:
          <<: *filter-pr-branch
          env_name: dev
          test_suite: all

  build-and-deploy-all-apps-workflow:
    # Develop branch only:
    # Trigger automatically when PR merge into develop branch
    unless: << pipeline.parameters.do-builds >>
    jobs:
      - conditionally-launch-build-and-deploy-all-job:
          <<: *filter-develop-branch

  build-and-deploy-workflow:
    when:
      and:
        - << pipeline.parameters.do-builds >>
        - equal: ["UNKNOWN", << pipeline.parameters.deploy_env >>]
    jobs:
      - build-and-deploy-job:
          study_key: << pipeline.parameters.study_key >>
          filters:
            branches:
              ignore:
                - /^rc.*/
                - /^hotfix.*/
      - playwright-e2e-test:
          # Run Playwright tests against Dev env after deploy changed apps (any study)
          filters:
            branches:
              ignore:
                - /^rc.*/
                - /^hotfix.*/
          env_name: dev
          test_suite: all
          requires:
            - build-and-deploy-job

  launch-all-app-builds-workflow:
    # using do-builds param to select which of the two workflows using the build-on-tag-filters
    # should run; should be this one that just launches the builds or the one actually doing the builds
    unless: << pipeline.parameters.do-builds >>
    jobs:
      - conditionally-launch-build-and-store-all-job: &build-and-store-filters
          filters:
            branches:
              only:
                - /^rc.*/
                - /^hotfix.*/

  build-app-workflow:
    when: << pipeline.parameters.do-builds >>
    jobs:
      - app-build-and-store-job:
          <<: *build-and-store-filters

  deploy-all-apps-workflow:
    jobs:
      - deploy-stored-build-job:
          filters:
            branches:
              only:
                - test
                - staging
          study_key: basil
      - deploy-stored-build-job: &deploy_branch_filters
          filters:
            branches:
              only:
                - test
                - staging
                - production
          study_key: osteo
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: brain
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: mbc
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: angio
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: testboston
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: mpc
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: atcp
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: rarex
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: rgp
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: esc
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: prion
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: cgc
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: circadia
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: pancan
      - deploy-stored-build-job:
          name: deploy-singular-app
          <<: *deploy_branch_filters
          study_key: singular
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: brugada
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: lms
      - deploy-stored-build-job:
          <<: *deploy_branch_filters
          study_key: fon
      - playwright-e2e-test:
          filters:
            branches:
              only:
                - test
                - staging
          test_suite: all
          optional_steps:
            - set-deployment-environment
          requires:
            - deploy-singular-app

  nightly:
    triggers:
      - schedule:
          cron: "0 22 * * *"
          filters:
            branches:
              only:
                - develop
    jobs:
      - build-and-deploy-job:
          name: basil-nightly
          study_key: basil
      - build-and-deploy-job:
          name: osteo-nightly
          study_key: osteo
      - build-and-deploy-job:
          name: angio-nightly
          study_key: angio
      - build-and-deploy-job:
          name: brain-nightly
          study_key: brain
      - build-and-deploy-job:
          name: mbc-nightly
          study_key: mbc
      - build-and-deploy-job:
          name: testboston-nightly
          study_key: testboston
      - build-and-deploy-job:
          name: mpc-nightly
          study_key: mpc
      - build-and-deploy-job:
          name: atcp-nightly
          study_key: atcp
      - build-and-deploy-job:
          name: rarex-nightly
          study_key: rarex
      - build-and-deploy-job:
          name: rgp-nightly
          study_key: rgp
      - build-and-deploy-job:
          name: esc-nightly
          study_key: esc
      - build-and-deploy-job:
          name: prion-nightly
          study_key: prion
      - build-and-deploy-job:
          name: cgc-nightly
          study_key: cgc
      - build-and-deploy-job:
          name: circadia-nightly
          study_key: circadia
      - build-and-deploy-job:
          name: pancan-nightly
          study_key: pancan
      - build-and-deploy-job:
          name: singular-nightly
          study_key: singular
      - build-and-deploy-job:
          name: brugada-nightly
          study_key: brugada
      - build-and-deploy-job:
          name: lms-nightly
          study_key: lms
      - build-and-deploy-job:
          name: fon-nightly
          study_key: fon
