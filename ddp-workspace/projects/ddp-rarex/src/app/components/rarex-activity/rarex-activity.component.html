<div *ngIf="!isLoaded" class="activity-spinner">
  <mat-spinner></mat-spinner>
</div>

<!-- article content -->
<article *ngIf="isLoaded" class="rarex-activity" [ngClass]="{'PageContent': isLoaded}">
  <div class="PageLayout">
    <div class="row NoMargin">
      <div *ngIf="shouldShowReadonlyHint" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="PageContent-infobox NoMargin" [innerHTML]="model.readonlyHint"></div>
      </div>

      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <!-- introduction section -->
        <!-- Check model not null and not undefined. Open to race condition -->
        <ng-container *ngIf="model && model.introduction">
          <ddp-activity-section
            [section]="model.introduction"
            [readonly]="model.readonly || dataEntryDisabled"
            [validationRequested]="validationRequested"
            [studyGuid]="studyGuid"
            [activityGuid]="activityGuid"
            (visibilityChanged)="updateVisibility($event)"
            (embeddedComponentsValidationStatus)="updateEmbeddedComponentValidationStatus(0, $event)"
            (embeddedComponentBusy)="embeddedComponentBusy$[0].next($event)"
          ></ddp-activity-section>
        </ng-container>
      </div>
    </div>

    <div *ngIf="isStepped && showStepper" class="activity-stepper">
      <ol class="activity-stepper__stepper-list stepper-list">
        <ng-container *ngFor="let section of model.sections; let i = index; let last = last">
          <ng-container *ngIf="section.visible">
            <li
              class="stepper-list__item"
              (click)="jumpStep(i)"
              [class.stepper-list__item--active]="isActive(i)"
              [class.stepper-list__item--completed]="isCompleted(i)"
            >
              <div class="stepper-step">
                <div class="stepper-step__icon">
                  <img [src]="setIcon(i, section.incompleteIcon, section.completeIcon)" />
                </div>

                <span class="stepper-step__title">
                  {{ section.name }}
                </span>
              </div>
            </li>
            <li *ngIf="!last" class="stepper-list__item--divider"></li>
          </ng-container>
        </ng-container>
      </ol>
    </div>

    <ng-container *ngIf="model">
      <div class="row NoMargin">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <ddp-activity-section
            [section]="currentSection"
            [readonly]="model.readonly || dataEntryDisabled"
            [validationRequested]="validationRequested"
            [studyGuid]="studyGuid"
            [activityGuid]="activityGuid"
            (visibilityChanged)="updateVisibility($event)"
            (embeddedComponentsValidationStatus)="updateEmbeddedComponentValidationStatus(1, $event)"
            (embeddedComponentBusy)="embeddedComponentBusy$[1].next($event)"
          ></ddp-activity-section>
        </div>
      </div>

      <div class="row NoMargin">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <!-- closing section -->
          <ng-container *ngIf="model.closing">
            <ddp-activity-section
              [section]="model.closing"
              [readonly]="model.readonly || dataEntryDisabled"
              [validationRequested]="validationRequested"
              [studyGuid]="studyGuid"
              [activityGuid]="activityGuid"
              (visibilityChanged)="updateVisibility($event)"
              (embeddedComponentsValidationStatus)="updateEmbeddedComponentValidationStatus(2, $event)"
              (embeddedComponentBusy)="embeddedComponentBusy$[2].next($event)"
            ></ddp-activity-section>
          </ng-container>

          <ng-container *ngIf="shouldShowReadonlyHint">
            <div class="PageContent-infobox topMarginMedium" [innerHTML]="model.readonlyHint"></div>
          </ng-container>

          <div *ngIf="model.lastUpdatedText" class="LastUpdatedText">
            <span>{{model.lastUpdatedText}}</span>
          </div>

          <div *ngIf="isLoaded" class="activity__btn-section">
            <div *ngIf="isStepped && !isFirstStep" class="activity__btn-section__left">
              <button
                class="button button_medium button_primary"
                [disabled]="(isPageBusy | async) || dataEntryDisabled"
                (click)="decrementStep()"
                [innerHTML]="'SDK.PreviousButton' | translate"
              ></button>
            </div>

            <div class="activity__btn-section__right">
              <button
                *ngIf="!isLastStep"
                class="button button_medium button_primary"
                [disabled]="(isPageBusy | async) || dataEntryDisabled"
                (click)="incrementStep()"
                [innerHTML]="(isPageBusy | async) ? ('SDK.SavingButton' | translate) : ('SDK.NextButton' | translate)"
              ></button>

              <ng-container *ngIf="isLastStep">
                <button
                  *ngIf="model.readonly"
                  class="button button_medium button_primary"
                  (click)="close()"
                  [innerHTML]="'SDK.CloseButton' | translate"
                ></button>

                <button
                  *ngIf="!model.readonly"
                  class="button button_medium button_primary"
                  #submitButton
                  [disabled]="(isPageBusy | async) || dataEntryDisabled"
                  (click)="flush()"
                  (mouseenter)="mouseEnterOnSubmit()"
                  [innerHTML]="(isPageBusy | async) ? ('SDK.SavingButton' | translate) : ('SDK.SubmitButton' | translate)"
                ></button>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <div *ngIf="displayGlobalError$ | async" class="ErrorMessage">
            <span translate>SDK.ValidateError</span>
          </div>

          <div *ngIf="communicationErrorOccurred" class="ErrorMessage">
            <span translate>SDK.CommunicationError</span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</article>
